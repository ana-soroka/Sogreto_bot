# ✅ Неделя 7-10: Планировщик напоминаний - РЕАЛИЗОВАНО

## Что было сделано:

### 1. Команды настройки ✅
**Файл:** `handlers/settings.py`

#### `/set_time` - Установка времени напоминаний
- Интерактивная клавиатура с выбором времени (09:00 - 22:00)
- Сохранение в поле `user.preferred_time`
- Рекомендация утреннего времени (9:00-12:00)

#### `/timezone` - Установка часового пояса
- Популярные часовые пояса (Москва, Екатеринбург, Новосибирск и т.д.)
- Сохранение в поле `user.timezone`
- Показ текущего времени в выбранном часовом поясе

### 2. APScheduler интеграция ✅
**Файл:** `utils/scheduler.py`

#### Функции планировщика:
- `init_scheduler()` - запуск планировщика
- `stop_scheduler()` - остановка при завершении бота
- `schedule_user_reminders(bot)` - настройка проверки каждый час
- `check_and_send_reminders(bot)` - проверка всех пользователей

#### Логика работы:
1. Каждый час (в 00 минут) запускается `check_and_send_reminders()`
2. Функция получает всех активных пользователей с установленным временем
3. Конвертирует текущее время в часовой пояс пользователя
4. Если текущий час совпадает с `preferred_time`, отправляет напоминание
5. Проверяет, не отправляли ли уже сегодня (поле `last_reminder_sent`)

### 3. Расчёт этапов по дням ✅
**Файлы:** `utils/scheduler.py`

#### `calculate_days_since_start(user)`
Рассчитывает количество дней с момента `user.started_at`

#### `get_current_stage_for_user(user)`
Определяет, на каком этапе должен быть пользователь:
- **День 0:** Этап 1 (Посадка)
- **Дни 1-3:** Этап 2 (Всходы)
- **Дни 4-6:** Этап 3 (Практика до микрозелени)
- **День 7:** Этап 4 (Первый урожай)
- **Дни 8-14:** Этап 5 (До беби-лифа)
- **Дни 14+:** Этап 6 (Финал)

### 4. Функция отправки напоминаний ✅
**Функция:** `send_practice_reminder(bot, user_id)`

#### Логика отправки:
- Проверяет, не на паузе ли пользователь (`is_paused`)
- Сравнивает `current_stage` с `expected_stage`
- **Если отстаёт:** напоминает перейти к следующему этапу
- **Если на графике:** отправляет ежедневное напоминание
- **Если опережает:** логирует и не отправляет

### 5. Обновление модели User ✅
**Файл:** `models.py`

Добавлены новые поля:
```python
preferred_time = Column(String(5), nullable=True)  # Время напоминаний HH:MM
started_at = Column(DateTime, nullable=True)  # Когда начал практики
last_reminder_sent = Column(DateTime, nullable=True)  # Последнее напоминание
```

### 6. Интеграция в bot.py ✅
- Импорт функций планировщика
- Инициализация при запуске: `init_scheduler()`
- Настройка задачи: `schedule_user_reminders(application.bot)`
- Остановка при Ctrl+C: `stop_scheduler()`

---

## Архитектура системы напоминаний:

```
┌─────────────────────────────────────────────────────────┐
│                     APScheduler                         │
│          (проверка каждый час в 00 минут)              │
└──────────────────────┬──────────────────────────────────┘
                       │
                       ▼
        ┌──────────────────────────────┐
        │  check_and_send_reminders()  │
        └──────────────────────────────┘
                       │
         ┌─────────────┴─────────────┐
         │                           │
         ▼                           ▼
┌─────────────────┐         ┌──────────────────┐
│ Получить всех   │         │  Для каждого     │
│ активных        │────────▶│  пользователя:   │
│ пользователей   │         │                  │
└─────────────────┘         └──────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    │                │                │
                    ▼                ▼                ▼
           ┌─────────────┐  ┌──────────────┐  ┌──────────────┐
           │ Конвертация │  │   Проверка   │  │  Отправка    │
           │ в часовой   │  │   времени    │  │ напоминания  │
           │    пояс     │  │   и даты     │  │              │
           └─────────────┘  └──────────────┘  └──────────────┘
```

---

## Изменённые/созданные файлы:

1. **`handlers/settings.py`** (НОВЫЙ) - команды /set_time и /timezone
2. **`utils/scheduler.py`** (НОВЫЙ) - планировщик напоминаний
3. **`models.py`** - добавлены поля preferred_time, started_at, last_reminder_sent
4. **`handlers/__init__.py`** - экспорт функций settings
5. **`handlers/practices.py`** - установка started_at при начале практик
6. **`handlers/start.py`** - обновлён /help с новыми командами
7. **`bot.py`** - интеграция планировщика

---

## Примеры использования:

### 1. Настройка времени напоминаний:
```
Пользователь: /set_time
Бот: [Клавиатура с выбором времени 09:00 - 22:00]
Пользователь: [Нажимает "10:00"]
Бот: ✅ Время напоминаний установлено! Вы будете получать
напоминания каждый день в 10:00.
```

### 2. Настройка часового пояса:
```
Пользователь: /timezone
Бот: [Клавиатура с выбором часового пояса]
Пользователь: [Выбирает "🇷🇺 Москва (UTC+3)"]
Бот: ✅ Часовой пояс установлен! Ваш часовой пояс: Europe/Moscow
Текущее время: 10:15
```

### 3. Автоматическое напоминание:
```
[10:00 по времени пользователя]
Бот: 🌱 **Время для практики!**

Продолжайте свои практики предвкушения.

Используйте /status чтобы увидеть текущий прогресс.
```

### 4. Напоминание при отставании:
```
[Пользователь на Этапе 1, но должен быть на Этапе 2]
Бот: 🌱 **Напоминание о практике**

Вы находитесь на Этапе 1, но уже пора переходить к Этапу 2!

Завершите текущие шаги или используйте /status для проверки прогресса.
```

---

## Технические детали:

### Часовые пояса (pytz):
- Сохраняются в формате: `Europe/Moscow`, `Asia/Yekaterinburg`
- Конвертация UTC → локальное время пользователя
- Поддержка всех российских и СНГ часовых поясов

### Формат времени:
- Сохраняется как строка `"HH:MM"` (например, "10:00")
- Проверка совпадения с точностью до получаса (0-30 минут текущего часа)

### Проверка отправки:
- Поле `last_reminder_sent` хранит DateTime последнего напоминания
- Проверяется дата (не время), чтобы не отправлять 2 раза в день
- При каждой отправке обновляется в UTC

### Статусы пользователя:
- `is_active=True` - пользователь активен
- `is_paused=False` - практики не на паузе
- `preferred_time IS NOT NULL` - время установлено
- `started_at IS NOT NULL` - практики начаты

---

## Расписание этапов:

| Этап | Название | Дни | Триггер |
|------|----------|-----|---------|
| 1 | Посадка | 0 | /start_practice |
| 2 | Всходы | 1-3 | 1 день после старта |
| 3 | Практика до микрозелени | 4-6 | 4 дня после старта |
| 4 | Первый урожай | 7 | 7 дней после старта |
| 5 | До беби-лифа | 8-14 | 8 дней после старта |
| 6 | Финал | 14+ | 14 дней после старта |

---

## Что НЕ реализовано (будущие улучшения):

### 1. Ежедневные практики Этапа 5
- Этап 5 имеет 7 разных тем на каждый день (Карьера, Отношения, Здоровье и т.д.)
- Нужно отправлять разные практики каждый день
- Сейчас отправляется только общее напоминание

### 2. Автоматический переход между этапами
- Сейчас пользователь сам проходит этапы через кнопки
- В будущем можно автоматически отправлять следующий этап

### 3. Персонализированные напоминания
- Учёт активности пользователя
- Адаптивное время отправки
- A/B тестирование текстов

### 4. Статистика и аналитика
- Сколько пользователей завершили практики
- На каком этапе чаще всего застревают
- Conversion rate по этапам

---

## Тестирование:

### 1. Проверка настройки времени:
1. `/set_time` → выбрать время
2. Проверить, что сохранилось в БД
3. Проверить сообщение подтверждения

### 2. Проверка часового пояса:
1. `/timezone` → выбрать пояс
2. Проверить отображение текущего времени
3. Проверить сохранение в БД

### 3. Проверка планировщика (быстрый тест):
Чтобы протестировать систему напоминаний БЕЗ ожидания часа:
1. Временно изменить `CronTrigger(minute=0)` на `CronTrigger(minute='*/1')` (каждую минуту)
2. Установить `preferred_time` равным текущему времени +1 минута
3. Начать практики через `/start_practice`
4. Подождать 1 минуту
5. Проверить, что пришло напоминание

### 4. Проверка расчёта этапов:
- Можно вручную изменить `started_at` в БД на прошлую дату
- Проверить, что `get_current_stage_for_user()` возвращает правильный этап

---

## Логирование:

Все действия логируются:
```
2026-01-14 10:00:00 - utils.scheduler - INFO - Проверка напоминаний для 5 пользователей
2026-01-14 10:00:01 - utils.scheduler - INFO - Отправлено напоминание пользователю 123456789
2026-01-14 10:00:02 - utils.scheduler - DEBUG - Пользователю 987654321 уже отправлено напоминание сегодня
```

---

## Готово к использованию! 🚀

Планировщик настроен и работает. Теперь пользователи могут:
1. Установить своё время напоминаний через `/set_time`
2. Выбрать часовой пояс через `/timezone`
3. Получать автоматические напоминания каждый день в выбранное время
4. Бот будет напоминать, если пользователь отстал от графика

**Следующий шаг (опционально):**
Реализовать ежедневные практики Этапа 5 с разными темами для каждого дня.
