"""
–£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º (APScheduler)
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∞–∫—Ç–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
"""
import logging
from datetime import datetime, timedelta
from apscheduler.schedulers.asyncio import AsyncIOScheduler
from apscheduler.triggers.cron import CronTrigger
from telegram import Bot, InlineKeyboardButton, InlineKeyboardMarkup
from models import SessionLocal, User
from utils.practices import practices_manager
import pytz

logger = logging.getLogger(__name__)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
scheduler = AsyncIOScheduler()


def init_scheduler():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
    if not scheduler.running:
        scheduler.start()
        logger.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω")


def stop_scheduler():
    """–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫"""
    if scheduler.running:
        scheduler.shutdown()
        logger.info("–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")


def calculate_days_since_start(user):
    """
    –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫

    Args:
        user: –æ–±—ä–µ–∫—Ç User –∏–∑ –ë–î

    Returns:
        int: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π
    """
    if not user.started_at:
        return 0

    now = datetime.utcnow()
    delta = now - user.started_at
    return delta.days


def get_current_stage_for_user(user):
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —ç—Ç–∞–ø–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–Ω–µ–π —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫

    Args:
        user: –æ–±—ä–µ–∫—Ç User –∏–∑ –ë–î

    Returns:
        int: –Ω–æ–º–µ—Ä —ç—Ç–∞–ø–∞ (1-6)
    """
    days = calculate_days_since_start(user)

    # –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏–∑ practices.json:
    # –≠—Ç–∞–ø 1: –¥–µ–Ω—å 1 (immediate)
    # –≠—Ç–∞–ø 2: –¥–Ω–∏ 2-4
    # –≠—Ç–∞–ø 3: –¥–Ω–∏ 5-7
    # –≠—Ç–∞–ø 4: –¥–µ–Ω—å 7
    # –≠—Ç–∞–ø 5: –¥–Ω–∏ 8-14 (7 –¥–Ω–µ–π)
    # –≠—Ç–∞–ø 6: –¥–Ω–∏ 14-20

    if days == 0:
        return 1
    elif 1 <= days <= 3:
        return 2
    elif 4 <= days <= 6:
        return 3
    elif days == 7:
        return 4
    elif 8 <= days <= 14:
        return 5
    elif days >= 14:
        return 6

    return user.current_stage


def should_send_reminder(user, days_since_start):
    """
    –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤ (–¥–Ω–µ–π –∏ —ç—Ç–∞–ø–æ–≤)

    Args:
        user: –æ–±—ä–µ–∫—Ç User
        days_since_start: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫

    Returns:
        tuple: (should_send: bool, message: str or None)
    """
    current_stage = user.current_stage
    current_step = user.current_step

    # –≠–¢–ê–ü 1 (–ü–æ—Å–∞–¥–∫–∞) - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–¥–µ–ª–∞–ª –ø–æ—Å–∞–¥–∫—É (step 6 –∑–∞–≤–µ—Ä—à—ë–Ω)
    if current_stage == 1:
        # –ï—Å–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª –≠—Ç–∞–ø 1 (–≤—Å–µ 6 —à–∞–≥–æ–≤)
        if current_step >= 6:
            # –î–µ–Ω—å 2: –ø–µ—Ä–≤–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—Ö–æ–¥—ã
            if days_since_start == 2:
                return True, (
                    "üå± **–ü–æ—Ä–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å—Ö–æ–¥—ã!**\n\n"
                    "–ü—Ä–æ—à–ª–æ 2 –¥–Ω—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–∞–¥–∫–∏. –û–±—ã—á–Ω–æ –≤ —ç—Ç–æ –≤—Ä–µ–º—è –ø–æ—è–≤–ª—è—é—Ç—Å—è –ø–µ—Ä–≤—ã–µ —Ä–æ—Å—Ç–∫–∏.\n\n"
                    "–ó–∞–≥–ª—è–Ω–∏—Ç–µ –≤ –≥–æ—Ä—à–æ–∫ - –≤–∏–¥–∏—Ç–µ –∑–µ–ª—ë–Ω—ã–µ –ø–µ—Ç–µ–ª—å–∫–∏? –ï—Å–ª–∏ –¥–∞, –ø—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–∏!\n\n"
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /status —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å."
                )
            # –î–µ–Ω—å 3: –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            elif days_since_start == 3:
                return True, (
                    "üåø **–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –≤—Å—Ö–æ–¥–∞—Ö**\n\n"
                    "–£–∂–µ 3 –¥–Ω—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–∞–¥–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥–æ—Ä—à–æ–∫ - –ø–æ—è–≤–∏–ª–∏—Å—å –ª–∏ —Ä–æ—Å—Ç–∫–∏?\n\n"
                    "–ï—Å–ª–∏ –Ω–µ—Ç - –Ω–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π—Ç–µ, –∏–Ω–æ–≥–¥–∞ —Å–µ–º–µ–Ω–∞–º –Ω—É–∂–Ω–æ —á—É—Ç—å –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏.\n\n"
                    "/status - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫–∏"
                )
            # –î–µ–Ω—å 4: –µ—â—ë –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
            elif days_since_start == 4:
                return True, (
                    "üåæ **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å—Ö–æ–¥–æ–≤**\n\n"
                    "4-–π –¥–µ–Ω—å –ø–æ—Å–ª–µ –ø–æ—Å–∞–¥–∫–∏. –ï—Å–ª–∏ —Ä–æ—Å—Ç–∫–∏ –µ—â—ë –Ω–µ –ø–æ–∫–∞–∑–∞–ª–∏—Å—å - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:\n"
                    "‚Ä¢ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –≤–ª–∞–≥–∏ –≤ –ø–æ—á–≤–µ?\n"
                    "‚Ä¢ –ù–∞–∫—Ä—ã—Ç –ª–∏ –≥–æ—Ä—à–æ–∫ –ø–ª—ë–Ω–∫–æ–π?\n"
                    "‚Ä¢ –°—Ç–æ–∏—Ç –ª–∏ –≤ —Ç—ë–ø–ª–æ–º –º–µ—Å—Ç–µ?\n\n"
                    "/status - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
                )
            # –î–µ–Ω—å 5: —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø–µ—Ä–µ—Å–∞–¥–∫–µ
            elif days_since_start == 5:
                return True, (
                    "‚ö†Ô∏è **–°–∞–ª–∞—Ç –Ω–µ –≤—Å—Ö–æ–¥–∏—Ç?**\n\n"
                    "–ü—Ä–æ—à–ª–æ —É–∂–µ 5 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–∞–¥–∫–∏. –ï—Å–ª–∏ –≤—Å—Ö–æ–¥–æ–≤ —Ç–∞–∫ –∏ –Ω–µ—Ç, –≤–æ–∑–º–æ–∂–Ω–æ:\n\n"
                    "‚Ä¢ –°–µ–º–µ–Ω–∞ –æ–∫–∞–∑–∞–ª–∏—Å—å –Ω–µ–≤—Å—Ö–æ–∂–∏–º–∏\n"
                    "‚Ä¢ –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤–ª–∞–≥–∏ –∏–ª–∏ —Å–≤–µ—Ç–∞\n"
                    "‚Ä¢ –°–ª–∏—à–∫–æ–º –≥–ª—É–±–æ–∫–æ –ø–æ—Å–∞–∂–µ–Ω—ã\n\n"
                    "**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Å–∞–¥–∏—Ç—å —Å–∞–ª–∞—Ç –∑–∞–Ω–æ–≤–æ:\n"
                    "1. –í–æ–∑—å–º–∏—Ç–µ –Ω–æ–≤—ã–µ —Å–µ–º–µ–Ω–∞\n"
                    "2. –£–≤–ª–∞–∂–Ω–∏—Ç–µ –ø–æ—á–≤—É\n"
                    "3. –ü–æ—Å–∞–¥–∏—Ç–µ –Ω–µ–≥–ª—É–±–æ–∫–æ (1-2 –º–º)\n"
                    "4. –ù–∞–∫—Ä–æ–π—Ç–µ –ø–ª—ë–Ω–∫–æ–π\n\n"
                    "–ü–æ—Å–ª–µ –ø–µ—Ä–µ—Å–∞–¥–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /reset —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ç—Å—á—ë—Ç –∑–∞–Ω–æ–≤–æ."
                )
        else:
            # –ï—Å–ª–∏ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª –≠—Ç–∞–ø 1, –Ω–∞–ø–æ–º–∏–Ω–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            if days_since_start >= 1:
                return True, (
                    "üå± **–ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø–æ—Å–∞–¥–∫—É!**\n\n"
                    f"–í—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –Ω–∞ —à–∞–≥–µ {current_step} –∏–∑ 6.\n\n"
                    "–ó–∞–≤–µ—Ä—à–∏—Ç–µ –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –≤—ã—Ä–∞—â–∏–≤–∞—Ç—å –≤–∞—à —Å–∞–ª–∞—Ç!\n\n"
                    "/status - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É"
                )

    # –≠–¢–ê–ü 2 (–í—Å—Ö–æ–¥—ã) - –¥–Ω–∏ 2-4
    elif current_stage == 2:
        # –ï—Å–ª–∏ –∑–∞—Å—Ç—Ä—è–ª –Ω–∞ –≠—Ç–∞–ø–µ 2 –±–æ–ª—å—à–µ 2 –¥–Ω–µ–π
        if days_since_start >= 5:
            return True, (
                "üåø **–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –ø—Ä–∞–∫—Ç–∏–∫–∏!**\n\n"
                "–í–∞—à–∏ —Ä–æ—Å—Ç–∫–∏ —É–∂–µ –ø–æ–∫–∞–∑–∞–ª–∏—Å—å? –û—Ç–ª–∏—á–Ω–æ!\n\n"
                "–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É –ø—Ä–∞–∫—Ç–∏–∫.\n\n"
                "/status - –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å"
            )

    # –≠–¢–ê–ü 3 (–ü—Ä–∞–∫—Ç–∏–∫–∞ –¥–æ –º–∏–∫—Ä–æ–∑–µ–ª–µ–Ω–∏) - –¥–Ω–∏ 5-7
    elif current_stage == 3:
        if days_since_start == 7:
            return True, (
                "üå± **–í—Ä–µ–º—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–∂–∞—è!**\n\n"
                "–ü—Ä–æ—à–ª–∞ –Ω–µ–¥–µ–ª—è —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–∞–¥–∫–∏. –í–∞—à–∞ –º–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å –≥–æ—Ç–æ–≤–∞ –∫ –ø–µ—Ä–≤–æ–º—É —Å–±–æ—Ä—É!\n\n"
                "–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –≠—Ç–∞–ø—É 4 - –ø—Ä–∞–∫—Ç–∏–∫–∞ ¬´–Ø–∫–æ—Ä—å¬ª –∏ –¥–µ–≥—É—Å—Ç–∞—Ü–∏—è.\n\n"
                "/status - –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
            )

    # –≠–¢–ê–ü 4 (–ü–µ—Ä–≤—ã–π —É—Ä–æ–∂–∞–π) - –¥–µ–Ω—å 7
    elif current_stage == 4:
        if days_since_start >= 8:
            return True, (
                "üåø **–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Ä–æ—Å—Ç—É –±–µ–±–∏-–ª–∏—Ñ–∞!**\n\n"
                "–í—ã –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª–∏ –º–∏–∫—Ä–æ–∑–µ–ª–µ–Ω—å? –¢–µ–ø–µ—Ä—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Ä–æ—Å—Ç–∫–∏ –±—É–¥—É—Ç —Ä–∞—Å—Ç–∏ –¥–∞–ª—å—à–µ.\n\n"
                "–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ –≠—Ç–∞–ø—É 5 - –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Å –±–æ–ª—å—à–∏–º–∏ —Ü–µ–ª—è–º–∏.\n\n"
                "/status - –Ω–∞—á–∞—Ç—å –≠—Ç–∞–ø 5"
            )

    # –≠–¢–ê–ü 5 (–î–æ –±–µ–±–∏-–ª–∏—Ñ–∞) - –¥–Ω–∏ 8-14
    elif current_stage == 5:
        # –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –≠—Ç–∞–ø–∞ 5 (7 –¥–Ω–µ–π)
        day_in_stage = days_since_start - 7  # –î–µ–Ω—å –≤–Ω—É—Ç—Ä–∏ –≠—Ç–∞–ø–∞ 5
        if 1 <= day_in_stage <= 7:
            return True, (
                f"üå± **–î–µ–Ω—å {day_in_stage} –∏–∑ 7: –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞**\n\n"
                f"–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ —Å–≤–æ–∏ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —Å –±–æ–ª—å—à–∏–º–∏ —Ü–µ–ª—è–º–∏.\n\n"
                f"–í–∞—à –±–µ–±–∏-–ª–∏—Ñ —Ä–∞—Å—Ç—ë—Ç, –∏ –≤–º–µ—Å—Ç–µ —Å –Ω–∏–º —Ä–∞—Å—Ç—É—Ç –≤–∞—à–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è.\n\n"
                "/status - —Å–µ–≥–æ–¥–Ω—è—à–Ω—è—è –ø—Ä–∞–∫—Ç–∏–∫–∞"
            )

    # –≠–¢–ê–ü 6 (–§–∏–Ω–∞–ª) - –¥–Ω–∏ 14-20
    elif current_stage == 6:
        if days_since_start >= 14:
            return True, (
                "üéâ **–§–∏–Ω–∞–ª—å–Ω—ã–π —ç—Ç–∞–ø!**\n\n"
                "–í–∞—à –±–µ–±–∏-–ª–∏—Ñ –≥–æ—Ç–æ–≤ –∫ —Å–±–æ—Ä—É! –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞—Å–ª–∞–¥–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º.\n\n"
                "–ü–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º —à–∞–≥–∞–º.\n\n"
                "/status - –∑–∞–≤–µ—Ä—à–∏—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É"
            )

    return False, None


async def send_practice_reminder(bot: Bot, user_id: int):
    """
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –ø—Ä–∞–∫—Ç–∏–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê)

    Args:
        bot: Telegram Bot instance
        user_id: telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    """
    db = SessionLocal()
    try:
        user = db.query(User).filter(User.telegram_id == user_id).first()

        if not user:
            logger.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ë–î")
            return

        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –Ω–∞ –ø–∞—É–∑–µ –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        if user.is_paused:
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–∞ –ø–∞—É–∑–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ")
            return

        # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–Ω–∏ —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫
        days = calculate_days_since_start(user)

        # –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
        should_send, message = should_send_reminder(user, days)

        if should_send and message:
            # –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –≤—Å—Ö–æ–¥–∞—Ö (–¥–Ω–∏ 2-5, —ç—Ç–∞–ø 1)
            keyboard = None
            if user.current_stage == 1 and user.current_step >= 6 and 2 <= days <= 5:
                keyboard = InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚úÖ –£ –º–µ–Ω—è –ø–æ—è–≤–∏–ª–∏—Å—å –ø–µ—Ä–≤—ã–µ –≤—Å—Ö–æ–¥—ã!", callback_data="sprouts_appeared")]
                ])

            await bot.send_message(
                chat_id=user_id,
                text=message,
                parse_mode='Markdown',
                reply_markup=keyboard
            )
            logger.info(f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} (–¥–µ–Ω—å {days}, —ç—Ç–∞–ø {user.current_stage})")
        else:
            logger.debug(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} (–¥–µ–Ω—å {days}, —ç—Ç–∞–ø {user.current_stage})")

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}: {e}")
    finally:
        db.close()


async def check_and_send_reminders(bot: Bot):
    """
    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ç–µ–º, –∫–æ–º—É –Ω—É–∂–Ω–æ
    –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º –∫–∞–∂–¥—ã–π —á–∞—Å
    """
    db = SessionLocal()
    try:
        # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ UTC
        now_utc = datetime.utcnow()

        # –ù–∞–π—Ç–∏ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π
        users = db.query(User).filter(
            User.is_active == True,
            User.is_paused == False,
            User.preferred_time.isnot(None),
            User.started_at.isnot(None)
        ).all()

        logger.info(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è {len(users)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π")

        for user in users:
            try:
                # –ü–æ–ª—É—á–∏—Ç—å —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                user_tz = pytz.timezone(user.timezone)

                # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                now_user_tz = now_utc.replace(tzinfo=pytz.utc).astimezone(user_tz)
                current_hour = now_user_tz.hour
                current_minute = now_user_tz.minute

                # –ü–∞—Ä—Å–∏—Ç—å preferred_time (—Ñ–æ—Ä–º–∞—Ç "HH:MM")
                if user.preferred_time:
                    hour, minute = map(int, user.preferred_time.split(':'))

                    # –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å preferred_time (—Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ —á–∞—Å–∞)
                    if current_hour == hour and 0 <= current_minute < 30:
                        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –ª–∏ —É–∂–µ —Å–µ–≥–æ–¥–Ω—è
                        if user.last_reminder_sent:
                            last_reminder_date = user.last_reminder_sent.date()
                            today = now_user_tz.date()

                            if last_reminder_date == today:
                                logger.debug(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id} —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Å–µ–≥–æ–¥–Ω—è")
                                continue

                        # –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–Ω–∏ —Å –Ω–∞—á–∞–ª–∞ –ø—Ä–∞–∫—Ç–∏–∫
                        days = calculate_days_since_start(user)

                        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω—É–∂–Ω–æ –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ (—Ç—Ä–∏–≥–≥–µ—Ä–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
                        should_send, _ = should_send_reminder(user, days)

                        if should_send:
                            # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                            await send_practice_reminder(bot, user.telegram_id)

                            # –û–±–Ω–æ–≤–∏—Ç—å –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
                            user.last_reminder_sent = now_utc
                            db.commit()
                        else:
                            logger.debug(f"–¢—Ä–∏–≥–≥–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id} (–¥–µ–Ω—å {days}, —ç—Ç–∞–ø {user.current_stage})")

            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.telegram_id}: {e}")
                continue

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ check_and_send_reminders: {e}")
    finally:
        db.close()


def schedule_user_reminders(bot: Bot):
    """
    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –∫–∞–∂–¥—ã–π —á–∞—Å

    Args:
        bot: Telegram Bot instance
    """
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–∂–¥—ã–π —á–∞—Å (–≤ –Ω–∞—á–∞–ª–µ —á–∞—Å–∞)
    scheduler.add_job(
        check_and_send_reminders,
        CronTrigger(minute=0),  # –ö–∞–∂–¥—ã–π —á–∞—Å –≤ 00 –º–∏–Ω—É—Ç
        args=[bot],
        id='check_reminders',
        replace_existing=True
    )
    logger.info("‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –Ω–∞—Å—Ç—Ä–æ–µ–Ω: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π —á–∞—Å –≤ 00 –º–∏–Ω—É—Ç")


def schedule_daily_stage5_practices(bot: Bot):
    """
    –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ –¥–ª—è –≠—Ç–∞–ø–∞ 5
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–∞–∫—Ç–∏–∫—É –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞ –≠—Ç–∞–ø–µ 5
    """
    # TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–º —ç—Ç–∞–ø–µ
    pass
